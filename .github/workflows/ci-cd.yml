name: CI/CD Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  # Frontend Build & Test
  frontend:
    name: Frontend CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm run typecheck || true

      - name: Build
        run: pnpm run build

  # Backend Lint
  backend:
    name: Backend CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: pdo, pdo_pgsql, pgsql, intl, zip

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-progress

      - name: PHP Lint
        run: find app -name "*.php" -print0 | xargs -0 -n1 php -l || true

  # Deploy via SSH
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: [frontend, backend]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    environment: production

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          command_timeout: 30m
          script: |
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
            REPO_URL="git@github.com:${{ github.repository }}.git"
            
            echo "=========================================="
            echo "🚀 開始部署"
            echo "=========================================="
            
            # 檢查目錄是否存在
            if [ ! -d "$DEPLOY_PATH" ]; then
                echo "📁 專案目錄不存在，正在初始化..."
                mkdir -p "$(dirname $DEPLOY_PATH)"
                git clone "$REPO_URL" "$DEPLOY_PATH"
            fi
            
            cd "$DEPLOY_PATH"
            
            echo ""
            echo "📥 拉取最新程式碼..."
            git fetch origin
            
            echo ""
            echo "🧹 清理未追蹤的文件..."
            git clean -fdx -e .env -e .env.local -e writable/ -e uploads/ -e data/
            
            echo ""
            echo "🔄 重置到最新提交..."
            git reset --hard origin/main || git reset --hard origin/master
            
            echo ""
            echo "📝 檢查環境設定..."
            if [ ! -f ".env" ]; then
                echo "   建立 .env..."
                cp .env.example .env
            fi
            
            echo ""
            echo "🔧 設定腳本權限..."
            chmod +x scripts/*.sh
            
            echo ""
            echo "🐳 啟動 Docker 服務..."
            docker compose down --remove-orphans 2>/dev/null || true
            docker compose up -d --build
            
            echo ""
            echo "⏳ 等待服務啟動 (30秒)..."
            sleep 30
            
            echo ""
            echo "🗄️ 執行資料庫遷移..."
            if docker compose exec -T backend php spark migrate --all; then
                echo "✅ 資料庫遷移完成！"
            else
                echo "⚠️ 資料庫遷移失敗，請檢查日誌"
            fi
            
            echo ""
            echo "📊 服務狀態："
            docker compose ps
            
            echo ""
            echo "🏥 健康檢查："
            NGINX_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:${NGINX_PORT:-8000}" 2>/dev/null || echo "000")
            BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:${BACKEND_PORT:-8080}" 2>/dev/null || echo "000")
            echo "   Nginx:   HTTP $NGINX_STATUS"
            echo "   Backend: HTTP $BACKEND_STATUS"
            
            echo ""
            echo "=========================================="
            if [ "$NGINX_STATUS" = "200" ] || [ "$NGINX_STATUS" = "304" ]; then
                echo "✅ 部署成功！"
            else
                echo "⚠️ 部署可能有問題，請檢查日誌"
                echo "   docker compose logs -f"
            fi
            echo "=========================================="
